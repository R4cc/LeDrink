@page "/favourites"
@using LeDrink.DAL.Interfaces
@using LeDrink.DAL.Models
@using Blazorise.Animate
@inject IUnitOfWork _uow

<div class="container" stlye="text-align: center; height: 320px;">
    <div class="row" >
        <div class="col-2">
            <button class="btn btn-primary"  @onclick="LastCard">Last</button>
        </div>
        <div class="col-8" style="height: 100%">
            @if(_currentDrink != null)
            {
                <RadzenCard Style="width: 100%; height: 100%">
                    <div class="d-flex ">
                        <div class="image"><RadzenImage Path="@_currentDrink.ImgPath" Class="rounded-circle" Style="width:150px; height: 150px; object-fit:cover;" /></div>
                        <div class="ml-3 w-100">
                            <h4>@_currentDrink.DrinkName</h4>
                            <div class="p-2 mt-2 bg-primary justify-content-between rounded text-white stats" >
                                @foreach(var mix in _currentDrink.Mixes)
                                {
                                    <div> 
                                        <a>@mix.Bottle.BottleName</a>
                                        <a class="number1" style="float: right;">@mix.Milliliters @(" ml")</a> 
                                    </div>
                                }
                            </div>
                            <div style="margin-top: 5%">
                                <Button @onclick="(() => MakeDrink(_currentDrink))" Type="@AntDesign.ButtonType.Primary" Style="width: 100%" Shape="@AntDesign.ButtonShape.Round">MAKE DRINK</Button>
                            </div>
                        </div>
                    </div>
                </RadzenCard>
            }
        </div>
        <div class="col-2">
            <button class="btn btn-primary" @onclick="NextCard">Next</button>
        </div>
    </div>
    </div>


@code {
    private List<Drink> _favDrinks = null;
    private Drink _currentDrink = null;
    private int _currentDrinkIndex = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDrinks();
            await NextCard();
        }
    }

    private async Task LoadDrinks()
    {
        _favDrinks = (await _uow.DrinkRepo.GetDrinks()).Where(d => d.IsFavourite == true).ToList();

        // Recursively load Bottle names into mix
        foreach(var drink in _favDrinks)
        {
            foreach(var mix in drink.Mixes)
            {
                mix.Bottle = await _uow.BottleRepo.GetBottle(mix.bottleId);
            }
        }
    }

    private async Task LastCard()
    {
        if(_currentDrinkIndex - 1  < 0)
        {
            // Sets cur index to max if its the first drink in the index
            _currentDrinkIndex = _favDrinks.Count()-1;
            _currentDrink = _favDrinks[_currentDrinkIndex];
            return;
        }
        _currentDrinkIndex--;
        _currentDrink = _favDrinks[_currentDrinkIndex];
    }

    private async Task NextCard()
    {
        if(_currentDrinkIndex + 1  > _favDrinks.Count() - 1)
        {
            // Sets cur index to first if its the last drink in the index
            _currentDrinkIndex = 0;
            _currentDrink = _favDrinks[_currentDrinkIndex];
            return;
        }
        _currentDrinkIndex++;

        _currentDrink = _favDrinks[_currentDrinkIndex];
    }
        
    private async Task MakeDrink(Drink drink)
    {
        await _uow.RaspiRepo.MakeDrink(drink);
    }
}
